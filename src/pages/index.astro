---
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import BaseLayout from "~/layouts/BaseLayout.astro";

const lang = "ja"; // 日本語ページとして固定
const artworks = await getCollection("artworks", ({ id }) => id.startsWith(`${lang}/`));
---
<BaseLayout>
  <section class="justified-gallery" id="gallery-container">
    {artworks.map((artwork, index) => (
      <a
        style={`--width: ${artwork.data.src.width}; --height: ${artwork.data.src.height};`}
        href={`/gallery/${artwork.slug.replace(`${lang}/`, "")}`}
        class="gallery-item"
      >
        <Image
          format="webp"
          src={artwork.data.src}
          alt={artwork.data.title}
          height={400}
          loading={index < 20 ? "eager" : "lazy"}
        />
      </a>
    ))}
  </section>
</BaseLayout>
<style is:inline>
  /* 以前のindex.astroのスタイルをそのままコピー */
  .justified-gallery {
    --padding: max(2.5vw, 12px);
    --space: max(2.5vw, 12px);
    --min-height: clamp(200px, 20vw, 400px);
    padding: var(--padding);
    display: flex;
    flex-wrap: wrap;
    gap: var(--space);
  }
  .justified-gallery a {
    flex-grow: calc(var(--width) * (100000 / var(--height)));
    flex-basis: calc(var(--min-height) * (var(--width) / var(--height)));
    aspect-ratio: var(--width) / var(--height);
    overflow: hidden;
    opacity: 1;
    transition: all 0.05s ease-in-out;
  }
  .justified-gallery a img {
    display: block;
    object-fit: cover;
    height: 100%;
    width: 100%;
  }
  .justified-gallery a:focus-visible {
    outline: 3px solid var(--outline);
    outline-offset: 2px;
    transform: scale(1.05);
    z-index: 1;
    border-radius: 2px;
    box-shadow: 0 2px 4px 2px rgba(0, 0, 0, 0.1);
  }
  .justified-gallery a.hidden {
    transition: opacity 0.4s ease-in-out;
    opacity: 0;
  }
  .justified-gallery::after {
    content: " ";
    flex-grow: 1000000000;
  }
  /* ▼▼▼ モバイル対応を追加 ▼▼▼ */
  @media (max-width: 768px) {
    .justified-gallery {
      --min-height: clamp(150px, 25vw, 250px); /* 最小高さを小さくする */
      --padding: max(1.5vw, 8px); /* 余白を少し減らす */
      --space: max(1.5vw, 8px);   /* 画像間のスペースを少し減らす */
    }
  }
</style>
<script is:inline>
  function shuffleArray(array) {
    let currentIndex = array.length,  randomIndex;
    while (currentIndex != 0) {
      randomIndex = Math.floor(Math.random() * currentIndex);
      currentIndex--;
      [array[currentIndex], array[randomIndex]] = [
        array[randomIndex], array[currentIndex]];
    }
    return array;
  }

  function shuffleGallery() {
    // id='gallery-container' を探す
    const gallery = document.getElementById('gallery-container');
    if (!gallery) return; // 見つからなければ何もしない

    // class='gallery-item' をすべて探す
    const items = Array.from(gallery.querySelectorAll('.gallery-item'));
    const shuffledItems = shuffleArray(items);

    // 要素をDOM上で移動させて並び替える
    shuffledItems.forEach(item => {
      gallery.appendChild(item);
    });
  }
  
  document.addEventListener('astro:page-load', shuffleGallery);

  shuffleGallery();
</script>