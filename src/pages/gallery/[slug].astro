---
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import BaseLayout from "~/layouts/BaseLayout.astro";
import { ui } from "~/i18n/ui";

const lang = "ja"; // 日本語ページとして固定

export async function getStaticPaths() {
  // 日本語の作品データのみを取得
  const artworks = await getCollection("artworks", ({ id }) => id.startsWith('ja/'));
  return artworks.map((artwork) => ({
    params: { slug: artwork.slug.replace(/^(ja)\//, '') }, // slugから言語プレフィックスを除去
    props: { artwork },
  }));
}

const { artwork } = Astro.props;
const { Content } = await artwork.render();
const t = ui[lang];

const hasPatreonUrl = artwork.data.patreonUrl && artwork.data.patreonUrl !== "None" && artwork.data.patreonUrl !== "";
const hasPatreonImage = !!artwork.data.patreonEmbedImageUrl;

let patreonPostId: string | null = null;
let isPatreonPostUrl = false;

if (hasPatreonUrl) {
  try {
    const url = new URL(artwork.data.patreonUrl);
    // patreon.com の /posts/ URLであるかを確認
    if (url.hostname.endsWith('patreon.com') && url.pathname.startsWith('/posts/')) {
      isPatreonPostUrl = true;
      
      // URLのパス部分（例: /posts/wu-liao-wu-tsuzi-142481220）
      // または（例: /posts/142481220）
      // から末尾の数字（投稿ID）を抽出
      const match = url.pathname.match(/(\d+)$/);
      if (match?.[1]) {
        patreonPostId = match[1];
      }
    }
  } catch (e) {
    // URLが無効な場合は何もしない
  }
}

// 関連イラストも日本語データから取得
const relatedArtworks = artwork.data.relatedImages ?
await getCollection('artworks', ({ id, slug }) => {
  const artworkLang = id.split('/')[0];
  const artworkSlug = slug.replace(/^(ja)\//, '');
  // '!' を '?' に変更 (Non-null assertionの削除)
  return artworkLang === lang && artwork.data.relatedImages?.includes(artworkSlug);
}) : [];
---
<BaseLayout title={artwork.data.title} description={artwork.data.description} keywords={artwork.data.keywords.join(', ')}>
  <div class="container">
    <article class="artwork-detail">
      <div class="main-image">
        <Image 
          src={artwork.data.src} 
          alt={artwork.data.title}
          quality="max"
          style="width: 100%; height: auto;"
        />
      </div>
      <div class="artwork-info">
        <h1>{artwork.data.title}</h1>

        {/* 1. Patreon投稿IDが抽出できた場合 -> <iframe> を表示 */}
        {isPatreonPostUrl && patreonPostId && (
          <div class="patreon-iframe-container">
            <iframe
              src={`https://www.patreon.com/posts/embed/${patreonPostId}`}
              width="100%"
              height="400"
              style="border: none; max-width: 600px; min-height: 400px; border-radius: 8px;"
              allowfullscreen
              frameborder="0"
            ></iframe>
          </div>
        )}

        {/* 2. 投稿IDは無いが、PatreonのURLと「バナー画像」が指定されている場合 -> 従来の画像バナーを表示 */}
        {hasPatreonUrl && !patreonPostId && hasPatreonImage && (
          <a href={artwork.data.patreonUrl} target="_blank" rel="noopener noreferrer" class="patreon-link">
            <Image 
              src={artwork.data.patreonEmbedImageUrl} 
              alt="Support on Patreon"
              width={800}
              height={200}
              format="webp"
              style="width: 100%; height: auto; border-radius: 8px; transition: transform 0.2s, box-shadow 0.2s;"
            />
          </a>
        )}

        <div class="artwork-body"><Content /></div>
        {relatedArtworks.length > 0 && (
          <div class="related-works">
            <h2>{t['artwork.related']}</h2>
            <div class="thumbnail-grid">
              {relatedArtworks.map((related) => (
                // 関連イラストへのリンクも /gallery/...
                <a href={`/gallery/${related.slug.replace(`${lang}/`, '')}`}>
                  <Image src={related.data.src} alt={related.data.title} width={150} height={150} />
                </a>
              ))}
            </div>
          </div>
        )}
      </div>
    </article>
  </div>
</BaseLayout>
<style is:inline>
  /* 以前の[slug].astroのスタイルをそのままコピー */
  .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
  .artwork-detail { display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; align-items: start; }
  .main-image { width: 100%; }
  h1 { font-size: 2.5rem; margin-bottom: 1.5rem; }
  .artwork-body { margin-top: 1.5rem; }
  .patreon-link img { width: 100%; border-radius: 8px; transition: transform 0.2s, box-shadow 0.2s; }
  .patreon-link:hover img { transform: scale(1.02); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
  .patreon-iframe-container {
    margin: 1.5rem auto; /* 上下に余白、左右は自動で中央揃え */
    width: 100%;
    max-width: 600px; /* Patreon埋め込みの推奨最大幅 */
  }
  .related-works { margin-top: 2rem; }
  .related-works h2 { font-size: 1.5rem; margin-bottom: 1rem; border-bottom: 2px solid #ccc; padding-bottom: 0.5rem; }
  .thumbnail-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 1rem; }
  .thumbnail-grid a { aspect-ratio: 1 / 1; }
  .thumbnail-grid img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; transition: transform 0.2s; }
  .thumbnail-grid img:hover { transform: scale(1.05); }
  @media (max-width: 768px) {
    .container {
      padding: 1rem; /* コンテナの余白を減らす */
    }
    .artwork-detail {
      grid-template-columns: 1fr; /* 1カラムレイアウトに変更 */
      gap: 1.5rem; /* 要素間のスペースを少し減らす */
    }
    h1 {
      font-size: 2rem; /* 見出しを少し小さくする */
    }
    .related-works h2 {
      font-size: 1.3rem; /* 見出しを少し小さくする */
    }
  }
  @media (prefers-color-scheme: dark) { .related-works h2 { border-color: #555; } }
</style>